---
title: "2D Moffat"
output: html_document
date: "2024-03-25"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The 2D Moffat Model has this form:

$$f(x,y) = A\left[1 + \frac{(x-x_{0})^2 + (y - y_{0})^2}{\alpha^2}\right]^{-\beta} $$
Where A = amplitude, $x0$ = x-position of the maximum, $y0$ = y-position of the maximum, $\alpha$ = core width, $\beta$ = power index.

Symmetric uncorr function - same influence

Similarly to the 1D Moffat, the amplitude must be greater than 0. Alpha can't be equal to zero and Beta must be greater than 0.

Visualising the 2D Moffat
```{r}
Moffat2D <- function(grid, parameters){
  x <- grid[[1]]
  y <- grid[[2]]
  
  amplitude <- parameters[[1]]
  x0 <- parameters[[2]]
  y0 <- parameters[[3]]
  alpha <- parameters[[4]]
  beta <- parameters[[5]]
  
  amplitude*(1+((x - x0)^2 + (y - y0)^2)/alpha^2)^(-beta)
}

#grid of variables
xRange <- seq(-5, 5, length = 100)
yRange <- seq(-5, 5, length = 100)
grid <- expand.grid(x = xRange, y = yRange)

#Dummy parameters
dummyParams <- c(amplitude = 1, x0 = 0, y0 = 0, alpha = 1, beta = 1)

z <- Moffat2D(grid, dummyParams)
zMatrix <- matrix(z, nrow = length(xRange), ncol = length(yRange))

image(xRange, yRange, zMatrix, xlab = "x", ylab = "y", main = "2D Moffat")
persp(xRange, yRange, zMatrix, xlab = "x", ylab = "y", zlab = "f(x,y)", main = "2D Moffat")
```

Visualising the effects of changing parameters
```{r}
#baseline of 1,0,0,1,1
dummyParams <- c(amplitude = 1, x0 = 0, y0 = 0, alpha = 1, beta = 1)
dummyParams1 <- c(amplitude = 4, x0 = 0, y0 = 0, alpha = 1, beta = 1)
dummyParams2 <- c(amplitude = 1, x0 = 3, y0 = 0, alpha = 1, beta = 1)
dummyParams3 <- c(amplitude = 1, x0 = 0, y0 = -2, alpha = 1, beta = 1)
dummyParams4 <- c(amplitude = 1, x0 = 0, y0 = 0, alpha = 3, beta = 1)
dummyParams5 <- c(amplitude = 1, x0 = 0, y0 = 0, alpha = 1, beta = 2.6)

#baseline plot
z <- Moffat2D(grid, dummyParams)
zMatrix <- matrix(z, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, zMatrix, xlab = "x", ylab = "y", main = "2D Moffat")

#increasing amplitude
z1 <- Moffat2D(grid, dummyParams1)
z1Matrix <- matrix(z, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, z1Matrix, xlab = "x", ylab = "y", main = "2D Moffat - Increasing A")

#moving x0
z2 <- Moffat2D(grid, dummyParams2)
z2Matrix <- matrix(z2, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, z2Matrix, xlab = "x", ylab = "y", main = "2D Moffat - Moving x0")

#moving y0
z3 <- Moffat2D(grid, dummyParams3)
z3Matrix <- matrix(z3, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, z3Matrix, xlab = "x", ylab = "y", main = "2D Moffat - Moving y0")

#Increasing alpha
z4 <- Moffat2D(grid, dummyParams4)
z4Matrix <- matrix(z4, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, z4Matrix, xlab = "x", ylab = "y", main = "2D Moffat - Increasing alpha")

#Increasing beta
z5<- Moffat2D(grid, dummyParams5)
z5Matrix <- matrix(z5, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, z5Matrix, xlab = "x", ylab = "y", main = "2D Moffat - Increasing beta")

persp(xRange, yRange, zMatrix, xlab = "x", ylab = "y", main = "2D Moffat")
persp(xRange, yRange, z1Matrix, xlab = "x", ylab = "y", main = "2D Moffat - Increasing A")
```

The Negative Log Likelihood of the 2D Moffat Model:
$$-\sum(\ln\left[A\right]-\beta\ln\left[1+\frac{(x-x_0)^2 + (y-y_0)^2}{\alpha^2}\right]) $$
```{r}
NLL <- function(grid, parameters){
  predictedDens <- Moffat2D(grid, parameters)
  return(-sum(log(predictedDens)))
}
```


Investigating how the parameters effect the negative log likelihood function
```{r}
#changing the value of the amplitude
amplitude <- seq(0.25, 5, by = 0.25)

i <- 1
changingA <- vector("numeric", length = 20)

while(i<=20){
  parameters <- c(amplitude[[i]], 1, 1, 1, 1)
  grid <- c(0,0)
  changingA[i] <- (NLL(grid, parameters))
  i <- i+1
}

#changing the value of x0
x0 <- seq(-5, 5, by = 0.5)

i <- 1
changingx0 <- vector("numeric", length = 21)

while(i<=21){
  parameters <- c(1, x0[[i]], 1, 1, 1)
  grid <- c(0,0)
  changingx0[i] <- (NLL(grid, parameters))
  i <- i+1
}

#changing the value of y0
y0 <- seq(-5, 5, by = 0.5)

i <- 1
changingy0 <- vector("numeric", length = 21)

while(i<=21){
  parameters <- c(1, 1, y0[[i]], 1, 1)
  grid <- c(0,0)
  changingy0[i] <- (NLL(grid, parameters))
  i <- i+1
}

#changing the value of alpha
alpha <- seq(0.25, 10, by = 0.25)

i <- 1
changingAlpha <- vector("numeric", length = 40)

while(i<=40){
  parameters <- c(1, 1, 1, alpha[[i]], 1)
  grid <- c(0,0)
  changingAlpha[i] <- (NLL(grid, parameters))
  i <- i+1
}

#changing the value of beta
beta <- seq(0.25, 10, by = 0.25)

i <- 1
changingBeta <- vector("numeric", length = 40)

while(i<=40){
  parameters <- c(1, 1, 1, 1, beta[[i]])
  grid <- c(0,0)
  changingBeta[i] <- (NLL(grid, parameters))
  i <- i+1
}

par(mfrow = c(2,3))
plot(amplitude, changingA, type = "l", xlab = "Amplitude", ylab = "Negative Log Likelihood")
plot(x0, changingx0, type = "l", xlab = "x0", ylab = "Negative Log Likelihood")
plot(y0, changingy0, type = "l", xlab = "x0", ylab = "Negative Log Likelihood")
plot(alpha, changingAlpha, type = "l", xlab = "Alpha", ylab = "Negative Log Likelihood")
plot(beta, changingBeta, type = "l", xlab = "Beta", ylab = "Negative Log Likelihood")
```
This is similar to the plots of the effects the parameters of the 1D Moffat Function have on the Negative Log Likelihood.

Amplitude needs to be expressed in terms of alpha and beta.

$$f(x,y) = \frac{\beta-1}{\pi\alpha^2}\left[1 + \frac{(x-x_{0})^2 + (y - y_{0})^2}{\alpha^2}\right]^{-\beta} $$
Validating the 2D Moffat PDF
```{r}
Moffat2DPDF <- function(parameters, x, y){
  x0 <- parameters[[1]]
  y0 <- parameters[[2]]
  alpha <- parameters[[3]]
  beta <- parameters[[4]]
  
  alpha <- pmax(alpha, 1e-6)
  beta <- pmax(beta, 1 + 1e-6)
  
  ((beta-1)/(pi*alpha^2))*(1+((x - x0)^2 + (y - y0)^2)/alpha^2)^(-beta)
}

library(pracma)
#Test 1
T1Params <- c(x0 = 1, y0 = 4, alpha = 0.4, beta = 2)
MoffatIntegral2D1 <- integral2(Moffat2DPDF, xmin = -100, xmax = 100, ymin = -100, ymax = 100, parameters = T1Params)[[1]]
MoffatIntegral2D1

#Test 2
T2Params <- c(x0 = -3, y0 = 7, alpha = 1.2, beta = 1.3)
MoffatIntegral2D2 <- integral2(Moffat2DPDF, xmin = -100, xmax = 100, ymin = -100, ymax = 100, parameters = T2Params)[[1]]
MoffatIntegral2D2

#Test 3
T3Params <- c(x0 = 4, y0 = 0, alpha = 3, beta = 2.4)
MoffatIntegral2D3 <- integral2(Moffat2DPDF, xmin = -100, xmax = 100, ymin = -100, ymax = 100, parameters = T3Params)[[1]]
MoffatIntegral2D3
```
```{r}
xRange <- seq(-20, 20, length = 200)
yRange <- seq(-20, 20, length = 200)
grid <- expand.grid(xRange, yRange)

A1 <- (T1Params[[4]]-1)/(pi * T1Params[[3]])
zT1 <- Moffat2D(grid, parameters = c(A1, T1Params))
zT1Matrix <- matrix(zT1, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, zT1Matrix)

A2 <- (T2Params[[4]]-1)/(pi * T2Params[[3]])
zT2 <- Moffat2D(grid, parameters = c(A2, T2Params))
zT2Matrix <- matrix(zT2, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, zT2Matrix)

A3 <- (T3Params[[4]]-1)/(pi * T3Params[[3]])
zT3 <- Moffat2D(grid, parameters = c(A3, T3Params))
zT3Matrix <- matrix(zT3, nrow = length(xRange), ncol = length(yRange))
image(xRange, yRange, zT3Matrix)

```

Gradient of the negative log likelihood with respect to each parameter
$$\frac{\delta}{\delta x_0} = -\sum\frac{2\beta(x-x_0)}{\alpha^2+(x-x_0)^2+(y-y_0)^2}$$
$$\frac{\delta}{\delta y_0} = -\sum\frac{2\beta(y-y_0)}{\alpha^2+(x-x_0)^2+(y-y_0)^2}$$
$$ \frac{\delta}{\delta\alpha} = 2\sum(\frac{1}{\alpha} + \frac{\beta((x-x_0)^2 + (y-y_0)^2)}{\alpha^3 + \alpha((x-x_0)^2+(y-y_0)^2)})$$
$$ \frac{\delta}{\delta\beta} = -\sum(\frac{1}{\beta} - \ln\left[1+\frac{(x-x_0)^2 + (y-y_0)^2}{\alpha^2}\right])$$
```{r}
NLL2D <- function(parameters, x, y){
  predictedDens <- Moffat2DPDF(parameters, x, y)
  return(-sum(log(predictedDens)))
}
```

```{r}
deriv2DNLL <- function(parameters, x, y){
  x0 <- parameters[[1]]
  y0 <- parameters[[2]]
  alpha <- parameters[[3]]
  beta <- parameters[[4]]
  
 dx0 <- -sum((2*beta*(x-x0))/(alpha^2 + (x-x0)^2 + (y-y0)^2))
 dy0 <- -sum((2*beta*(y-y0))/(alpha^2 + (x-x0)^2 + (y-y0)^2))
 dAlpha <- 2*sum(1/alpha + (beta*((x-x0)^2 + (y-y0)^2))/(alpha^3 + alpha*((x-x0)^2 + (y-y0)^2)))
 dBeta <- -sum(1/beta - log(1+((x-x0)^2 + (y-y0)^2)/alpha^2))
  
  return(c(dx0, dy0, dAlpha, dBeta))
}
```

```{r}
mean(POI2$x)
mean(POI2$y)
```


```{r}
initGuess <- c(x0 = 4115.227, y0 = 4052.706, alpha = 1, beta = 2)
lowerBounds <- c(0, 0, 1e-6, 1+1e-6)

result2D <- optim(par = initGuess, fn = NLL2D, gr = deriv2DNLL, x = POI2$x, y = POI2$y, method = "L-BFGS-B", lower = lowerBounds)
result2D
optimPOI2Par <- result2D$par
optimPOI2Par
```

```{r}
xRange <- seq(4110, 4120, length = 100)
yRange <- seq(4045, 4055, length = 100)
grid <- expand.grid(x = xRange, y = yRange)

amplitude <- (optimPOI2Par[[4]]-1)/(pi*optimPOI2Par[[3]]^2)
parameters <- c(amplitude, optimPOI2Par)

zPOI2<- Moffat2D(grid, parameters)
zPOI2Matrix <- matrix(zPOI2, nrow = length(xRange), ncol = length(yRange))
par(pty = "s")
image(xRange, yRange, zPOI2Matrix, xlab = "x", ylab = "y", main = "2D Moffat")
persp(xRange, yRange, zPOI2Matrix, xlab = "x", ylab = "y", main = "2D Moffat")
```

```{r}
model <- ggplot(POI2, aes(x,y)) +
  geom_pointdensity(adjust = 0.05, size = 0.1, shape = "1") + 
  scale_color_viridis(direction = -1, option = "B", trans = "log", breaks = c(10, 100, 1000)) + 
  coord_fixed()

library(ggExtra)
ggMarginal(model, type = "histogram")
```

Looking at other sources
Celestial Source 1
```{r}
mean(celestialSource1$x)
mean(celestialSource1$y)
```
```{r}
initGuess <- c(x0 = 4039.865, y0 = 4071.066, alpha = 1, beta = 2)
lowerBounds <- c(0, 0, 1e-6, 1+1e-6)

result2D <- optim(par = initGuess, fn = NLL2D, gr = deriv2DNLL, x = celestialSource1$x, y = celestialSource1$y, method = "L-BFGS-B", lower = lowerBounds)
optimCS1Par <- result2D$par
optimCS1Par
```
```{r}
xRange <- seq(4030, 4050, length = 100)
yRange <- seq(4060, 4080, length = 100)
grid <- expand.grid(x = xRange, y = yRange)

amplitude <- (optimCS1Par[[4]]-1)/(pi*optimCS1Par[[3]]^2)
parameters <- c(amplitude, optimCS1Par)

zCS1<- Moffat2D(grid, parameters)
zCS1Matrix <- matrix(zCS1, nrow = length(xRange), ncol = length(yRange))
par(pty = "s")
image(xRange, yRange, zCS1Matrix, xlab = "x", ylab = "y", main = "2D Moffat")
```

Celestial Source 2
```{r}
mean(celestialSource2$x)
mean(celestialSource2$y)
```

```{r}
initGuess <- c(x0 = 4073.925, y0 = 4105.563, alpha = 1, beta = 2)
lowerBounds <- c(0, 0, 1e-6, 1+1e-6)

result2D <- optim(par = initGuess, fn = NLL2D, gr = deriv2DNLL, x = celestialSource2$x, y = celestialSource2$y, method = "L-BFGS-B", lower = lowerBounds)
optimCS2Par <- result2D$par
optimCS2Par
```
```{r}
xRange <- seq(4070, 4080, length = 100)
yRange <- seq(4100, 4110, length = 100)
grid <- expand.grid(x = xRange, y = yRange)

amplitude <- (optimCS2Par[[4]]-1)/(pi*optimCS1Par[[3]]^2)
parameters <- c(amplitude, optimCS2Par)

zCS2<- Moffat2D(grid, parameters)
zCS2Matrix <- matrix(zCS2, nrow = length(xRange), ncol = length(yRange))
par(pty = "s")
image(xRange, yRange, zCS2Matrix, xlab = "x", ylab = "y", main = "2D Moffat")
```

Celestial Source 3
```{r}
mean(celestialSource3$x)
mean(celestialSource3$y)
```
```{r}
initGuess <- c(x0 = 4074.631, y0 = 4156.233, alpha = 1, beta = 2)
lowerBounds <- c(0, 0, 1e-6, 1+1e-6)

result2D <- optim(par = initGuess, fn = NLL2D, gr = deriv2DNLL, x = celestialSource3$x, y = celestialSource3$y, method = "L-BFGS-B", lower = lowerBounds)
optimCS3Par <- result2D$par
optimCS3Par
```
```{r}
xRange <- seq(4070, 4080, length = 100)
yRange <- seq(4150, 4160, length = 100)
grid <- expand.grid(x = xRange, y = yRange)

amplitude <- (optimCS3Par[[4]]-1)/(pi*optimCS1Par[[3]]^2)
parameters <- c(amplitude, optimCS3Par)

zCS3<- Moffat2D(grid, parameters)
zCS3Matrix <- matrix(zCS3, nrow = length(xRange), ncol = length(yRange))
par(pty = "s")
image(xRange, yRange, zCS3Matrix, xlab = "x", ylab = "y", main = "2D Moffat")
```


extract contours from the model 
marginal curves

GoF ? 

simulating background noise - poisson generated noise
modelling multiple close together << 
