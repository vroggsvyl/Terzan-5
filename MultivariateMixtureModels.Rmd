---
title: "Multivariate Mixture Models"
output: html_document
date: "2024-04-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Importing the Data
```{r}
library(here)
i_am("MultivariateMixtureModels.Rmd")
# laptop data from csv
Terzan5 <- readr::read_csv(here("Data", "Terzan 5 X-ray events.csv"), col_types = list(.default = readr::col_guess()), )
# head(Terzan5)

#fishbowl data from ODS
# library(readODS)
# Terzan5 <- read_ods(here("Raw Data.ods"), col_types = list(.default = readr::col_guess()), )
#removing extraneous columns
T5 <- data.frame(Terzan5$x, Terzan5$y)
colnames(T5) <- c('x','y')

library(ggplot2)
library(ggpointdensity)
library(viridis)

ggplot(T5,aes(x,y)) + 
  geom_pointdensity(adjust = 0.05, size = 0.1, shape = "1") + 
  scale_color_viridis(direction = -1, option = "B", trans = "log", breaks = c(10, 100, 1000, 10000)) + 
  coord_fixed()
```
Filtering down to area of interest
```{r}
library(tidyr)
library(plotly)
interestArea <- T5 %>%
  filter(x>4100 & x<4150 & y>4025 & y<4075)

ggplot(interestArea,aes(x,y)) + 
  geom_pointdensity(adjust = 0.05, size = 0.1, shape = "1") + 
  scale_color_viridis(direction = -1, option = "B", trans = "log", breaks = c(4, 16, 64)) + 
  coord_fixed()
```
```{r}
ggplot(interestArea,aes(x,y)) +
  geom_point(size = 0.5)
```


There is three clearly evident celestial sources in this area.
There are two small areas that could also be celestial sources (located above and below the highest definitive source).

I will be attempting to fit a multivariate mixture model for the entire area. The model will contain three(?) individual 2D Moffat distributions.

The lowest and densest source has already been modelled individually and is denoted as POI2 in previous Rmarkdown files. 

```{r}
library(mixtools)

set.seed(111)
data1 <- cbind(rnorm(100, mean = 0, sd = 1), rnorm(100, mean = 0, sd = 1))
data2 <- cbind(rnorm(100, mean = 5, sd = 1), rnorm(100, mean = 5, sd = 1))

datafull <- rbind(data1, data2)
plot(data1)
plot(data2)
plot(datafull)

fit <- mvnormalmixEM(datafull, k = 2)

names(fit)

fit$lambda
fit$mu
fit$sigma

fit$loglik
#fit$posterior
fit$all.loglik
fit$restarts

plot.mixEM(fit, whichplots = 2)
plot.mixEM(fit, whichplots = 1)
```
From the results 

lambda returns the weightings of each cluster

The mean location of the first cluster (red) is (-0.012, -0.016) 
The mean location of the second cluster (green) is (5.14, 5.02)

Sigma returns the covariance matrixes

```{r}
trial <- mvnormalmixEM(interestArea, k = 3)
```

```{r}
par(pty = "s")
plot.mixEM(trial, whichplots = 2)
```

```{r}
plot.mixEM(trial, whichplots = 1)
trial$lambda
trial$mu
trial$sigma
```
- returns values of (4115.262, 4051.881), for the celestial source that has already been examined.
Individually this returned (4115.261, 4051.904)
```{r}
library(mixAK)
NMixEM(datafull, K = 2)
```
This returns the same values as the mixtools packages - however it displays it in a much neater way.


Mean Vector and Covariance Matrix
```{r}
set.seed(222)
randomMatrix <- matrix(rnorm(10), nrow = 5)
randomMatrix

colMeans(randomMatrix)
cov(randomMatrix)
```
```{r}
#generate random cluster 2
set.seed(224)
randomMatrix2 <- matrix(rnorm(500, mean = 3, sd = 0.4), nrow = 250)
mean2 <- colMeans(randomMatrix2)
covmat2 <- cov(randomMatrix2)
det2 <- det(covmat2)

#generate random cluster 3
set.seed(225)
randomMatrix3 <- matrix(rnorm(500, mean = 1, sd = 0.2), nrow = 250)
mean3 <- colMeans(randomMatrix3)
covmat3 <- cov(randomMatrix3)
det3 <- det(covmat3)

#asign a random point somewhere in the region
z <- matrix(c(3, 3.2), nrow = 1)
```
```{r}
plot(randomMatrix2[,1], randomMatrix2[,2], xlim = c(-2, 5), ylim = c(-2, 5))#random cluster 2
points(randomMatrix3[,1], randomMatrix3[,2], col = "red")#random cluster 3
```

```{r}
randomClusters <- rbind(randomMatrix2, randomMatrix3)
fit1 <- mvnormalmixEM(randomClusters, k = 2)
fit1
plot.mixEM(fit1, whichplots = 2)
points(z[,1], z[,2], col = "blue") #random point - what's the density of this point if it exists in either cluster?
fit2 <- NMixEM(randomClusters, K= 2)
fit2
```
The parameters have been estimated using a spatial mixture model - I want to know associated density of a random point z. where z is (2,1)
```{r}
#Using the estimated parameters
c1 <- exp(-0.5*(z-fit1$mu[[1]]) %*% solve(fit1$sigma[[1]]) %*% t(z-fit1$mu[[1]]))/(2*pi*sqrt(det(fit1$sigma[[1]])))
c2 <- exp(-0.5*(z-fit1$mu[[2]]) %*% solve(fit1$sigma[[2]]) %*% t(z-fit1$mu[[2]]))/(2*pi*sqrt(det(fit1$sigma[[2]])))
c1
c2
fit1$lambda[[1]]*c1+fit1$lambda[[2]]*c2
```

```{r}
#Using the known data
p1 <- (1/(2*pi*sqrt(det2)))*exp(-0.5*(z-mean2) %*% solve(covmat2) %*% t(z-mean2)) #component density if existing in cluster 2
p2 <- (1/(2*pi*sqrt(det3)))*exp(-0.5*(z-mean3) %*% solve(covmat3) %*% t(z-mean3)) #component density if existing in cluster 3
pz <- 0.5*p1 + 0.5*p2 #component density of existing in either cluster
p1
p2
pz
```