---
title: "Exploring R"
output:
  word_document: default
  html_document: default
date: '2023-11-01'
---

```{r}
library(ggplot2)
library(plotly)
library(readr)
library(ggpointdensity)
library(viridis)
library(tidyr)
library(fitdistrplus)
library(rlang)
```

```{r}
set.seed(0)
g1 <- rgamma(1000, shape = 2, rate = 1)

set.seed(1)
g2 <- rgamma(1000, shape = 10, rate = 1)

set.seed(2)
g3 <- rgamma(1000, shape = 2, rate = 10)

set.seed(3)
g4 <- rgamma(1000, shape = 10, rate = 10)

par(mfrow = c(2,2))
hist(g1)
hist(g2)
hist(g3)
hist(g4)
```

```{r}
(function(x, y){ z <- x^2 + y^2; x+y+z })(0:7, 1)
norm <- function(x) sqrt(x%*%x)
norm(1:4)

```


```{r}
#Generate Random Data
set.seed(6)
dat <- rnorm(1000)
```


```{r}
#Moffat 1D
#One Dimensional Moffat Model

#Model Formula
#f(x) = A(1+(x-mu)^2/gamma^2)^-alpha

#Parameters
#A = Amplitude
#mu = the x position of the maximum of the model 
#gamma = core width of the model
#alpha = power index

#Defaults
#Amplitude = 1
#mu = 0
#gamma = 1
#alpha = 1

dMoffat1D <- function(x, amplitude, mu, gamma, alpha){amplitude*(1+((x-mu)/gamma)^2)^-alpha}

Moffat1D_Deriv <- function(x, amplitude, mu, gamma, alpha){
  chain = (1 + (x - mu)^2 / gamma^2)
  d_A = chain^(-alpha)
  d_mu = 2*amplitude*alpha*(x - mu)*d_A/(chain*gamma^2)
  d_gamma = 2*amplitude*alpha*((x - mu)^2)*d_A/(chain*gamma^3)
  d_alpha = -amplitude*d_A*log(chain)
  
  return(list(c(d_A, d_mu, d_gamma, d_alpha)))
}
```

```{r}
plot(dat)
hist(dat)
```
```{r}
dMoffat1D(2, 1, 0, 1, 1)
x <- c(-10:10)
plot(dMoffat1D(x, 1, 0, 1, 1), )
```
```{r}
Moffat1D_Deriv(0.5, 1, 0, 1, 1)
```

```{r}
set.seed(8)

randata <- rgamma(1000, 9, 2)
plot(randata)
hist(randata)
beta = 2
alpha = 9
```


```{r}
Gamma <- function(x, alpha, beta){
  ((beta^alpha)/factorial(alpha-1))* x^(alpha-1)* exp(-beta*x)
}

range <- seq(0,25, by=0.1)


plot(Gamma(range, 9, 2))
plotdist(randata, demp = TRUE)

#check
Gamma(5, 9, 2)
dgamma(5, 9, 2)

#res <- optim(c(5,9,2), Gamma)
```


```{r}
#optim example code
## "wild" function , global minimum at about -15.81515
fw <- function (x)
    10*sin(0.3*x)*sin(1.3*x^2) + 0.00001*x^4 + 0.2*x+80
plot(fw, -50, 50, n = 1000, main = "optim() minimising 'wild function'")

res <- optim(50, fw, method = "SANN",
             control = list(maxit = 20000, temp = 20, parscale = 20))
res
```

```{r}
range2 <- seq(-3, 3, by = 0.1)

par(mfrow = c(2,3))
plot(dMoffat1D(range2, 1, 0, 1, 1), main = "Default parameters")
plot(dMoffat1D(range2, 1, 0, 1, 2), main = "Changing alpha")
plot(dMoffat1D(range2, 1, 1, 1, 1), main = "Changing mu")
plot(dMoffat1D(range2, 1, 0, 0.5, 1), main = "Changing gamma")
plot(dMoffat1D(range2, 4, 0, 1, 1), main = "Changing A")
plot(dMoffat1D(range2, 4, 1, 4, 4), main = "Changing all")
```
```{r}
dMoffat1D <- function(x, amplitude, mu, gamma, alpha){
  amplitude*(1+((x-mu)/gamma)^2)^-alpha
  amplitude = min(0)
  gamma = min(0)
  alpha = min(0)}

Moffat1D_Deriv <- function(x, amplitude, mu, gamma, alpha){
  chain = (1 + (x - mu)^2 / gamma^2)
  d_A = chain^(-alpha)
  d_mu = 2*amplitude*alpha*(x - mu)*d_A/(chain*gamma^2)
  d_gamma = 2*amplitude*alpha*((x - mu)^2)*d_A/(chain*gamma^3)
  d_alpha = -amplitude*d_A*log(chain)
  
  return(list(c(d_A, d_mu, d_gamma, d_alpha)))
}
#optim(c(0, 1, 0, 1, 1), dMoffat1D, Moffat1D_Deriv)
```

```{r}
#data to fit to
plotdist(line2$x)
plot(line2)

xl2 <- line2$x
plot(xl2)
```

```{r}
# Define the Gaussian density function
gaussian_density <- function(x, mean, sd) {
  return(dnorm(x, mean = mean, sd = sd))
}

# Define the negative log-likelihood function for Gaussian distribution
negative_log_likelihood <- function(parameters, x) {
  mean <- parameters[1]
  sd <- parameters[2]
  
  predicted_density <- gaussian_density(x, mean, sd)
  return(-sum(log(predicted_density)))
}

# Set initial guesses for parameters
initial_guess <- c(mean = 0, sd = 1)

# Generate some sample data
set.seed(123)
sampleData <- rnorm(1000, mean = 2, sd = 1)
plot(sampleData)

# Optimize the negative log-likelihood function
result <- optim(par = initial_guess, fn = negative_log_likelihood, x = sample_data, method = "Nelder-Mead")

# Extract the optimized parameters
optimized_parameters <- result$par
print(optimized_parameters)

#plot time
xVal <- seq(min(sampleData), max(sampleData), length = 1000)
optimisedDens <- gaussian_density(x = xVal, mean = optimized_parameters[1], sd = optimized_parameters[2])
```

````{r}
MoffatNS <- function(parameters, x){
  amplitude <- parameters[1]
  mu <- parameters[2]
  gamma <- parameters[3]
  alpha <- parameters[4]
  
  amplitude*(1+((x-mu)^2/gamma^2))^(-alpha)
}

MS <- function(parameters, x){
  predicted <- MoffatNS(parameters, x)
  return(sum(predicted))
}

#Define the function
Moffat1D <- function(parameters, x){
  amplitude <- parameters[1]
  mu <- parameters[2]
  gamma <- parameters[3]
  alpha <- parameters[4]
  
  predicted <- amplitude*(1+((x-mu)^2/gamma^2))^(-alpha)
  return(sum(predicted))
}

negLogLike <- function(parameters, x){
  amplitude <- parameters[1]
  mu <- parameters[2]
  gamma <- parameters[3]
  alpha <- parameters[4]
  predictedDens <- MoffatNS(parameters, x)
  return(-sum(log(predictedDens)))
}
 
MoffatDeriv <- function(parameters, x){
  amplitude <- parameters[1]
  mu <- parameters[2]
  gamma <- parameters[3]
  alpha <- parameters[4]
  

  d_A = sum((1 + (x - mu)^2 / gamma^2)^(-alpha))
  d_mu = -2*sum(amplitude*alpha*(x - mu)*(1 + (x - mu)^2 / gamma^2)^(-alpha)/((1 + (x - mu)^2 / gamma^2)*gamma^2))
  d_gamma = -2*sum(amplitude*alpha*((x - mu)^2)*(1 + (x - mu)^2 / gamma^2)^(-alpha)/((1 + (x - mu)^2 / gamma^2)*gamma^3))
  d_alpha = sum(amplitude*(1 + (x - mu)^2 / gamma^2)^(-alpha)*log((1 + (x - mu)^2 / gamma^2)))
  
  return((c(d_A, d_mu, d_gamma, d_alpha)))
}
#set initial guesses
initialGuess <- c(amplitude = 1, mu = 0, gamma = 1, alpha = 1)
#set bounds
lowerBounds <- c(0,-Inf, 0, 0)
upperBounds <- c(Inf, Inf, Inf, Inf)

#Optimise
result <- optim(par = initialGuess, fn = negLogLike, x = sampleData, method = "L-BFGS-B")
optimPar <- result$par
print(optimPar)

result2 <- optim(par = initialGuess, fn = negLogLike, gr = MoffatDeriv, x = sampleData, method = "L-BFGS-B", lower = lowerBounds)
optimPar2 <- result2$par
print(optimPar2)

#plot time
xVal <- seq(min(sampleData), max(sampleData), length = 1000)

optimisedDens <- MoffatNS(optimPar, xVal)

optDens2 <- MoffatNS(optimPar2, xVal)
```
```{r}
plot(MoffatNS(sampleData, initialGuess))
plot(MoffatNS(initialGuess, sampleData))
```
```{r}
plot(sampleData)
plot(xVal, optimisedDens, type = "l", main = "Optimised Density Function (Gaussian)", xlab = "x", ylab = "Density")

plot(xVal, optimisedDens, type = "l", main = "Optimised Density Function (Moffat, NLL)", xlab = "x", ylab = "Density")

plot(xVal, optDens2, type = "l", main = "Optimised Density Function (Moffat, grad)", xlab = "x", ylab = "Density")

```


```{r}
#Fitting to data
#plot(xl2)

#set initial guesses
initialGuess <- c(amplitude = 1, mu = 4115, gamma = 1, alpha = 1)

#Optimise
result <- optim(par = initialGuess, fn = Moffat1D, x = xl2, lower = lowerBounds, method = "L-BFGS-B")
optimPar <- result$par
print(optimPar)

#plot
xVal <- seq(min(xl2), max(xl2), length = 963)
optimisedDens <- MoffatNS(optimPar, xVal)
plot(xVal, optimisedDens, type = "l", main = "Optimised Density Function", xlab = "x", ylab = "Density")
legend("topright", legend = "Optimised Density", lty = 1)

par(mfrow = c(1,2))
plot(xl2)
plot(MoffatNS(optimPar, xl2))
```

```{r}
#Optimise
resultl2 <- optim(par = initialGuess, fn = negLogLike, x = xl2, method = "L-BFGS-B", lower = lowerBounds, upper = upperBounds)
optimParl2 <- resultl2$par
print(optimParl2)
optDenl2 <- MoffatNS(optimParl2, xVal)
plot(xVal, optDenl2, type = "l", main = "Optimised Density Function", xlab = "x", ylab = "Density")
```

```{r}
plot(MoffatNS(initialGuess, xl2))
print(MoffatNS(initialGuess, xl2))
```

```{r}
#Fitting to data
#plot(xl2)

#set initial guesses
initialGuess <- c(amplitude = 1, mu = 4115, gamma = 1, alpha = 1)

#Optimise
result <- optim(par = initialGuess, fn = Moffat1D, x = xl2.5, lower = lowerBounds, method = "L-BFGS-B")
optimPar <- result$par
print(optimPar)

#plot
xVal <- seq(min(xl2.5), max(xl2.5), length = 291)
optimisedDens <- MoffatNS(optimPar, xVal)
plot(xVal, optimisedDens, type = "l", main = "Optimised Density Function", xlab = "x", ylab = "Density")
legend("topright", legend = "Optimised Density", lty = 1)

par(mfrow = c(1,2))
plot(xl2.5)
plot(MoffatNS(optimPar, xl2.5))
```